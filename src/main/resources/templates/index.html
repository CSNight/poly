<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>保利抢票</title>
    <link rel="stylesheet" th:href="@{css/elementui.css}">
    <script th:src="@{js/axios.js}"></script>
    <script th:src="@{js/vue2.6.12.js}"></script>
    <script th:src="@{js/websocket.js}"></script>
    <script src="https://g.alicdn.com/AWSC/AWSC/awsc.js"></script>
    <style>
        html, body {
            padding: 0;
            margin: 0
        }
    </style>
</head>
<body>
<div id="app" style="height:100vh;width:100%;display: flex;justify-content: center;align-items: center">
    <div style="width: 700px;display: block">
        <div style="width:100%;display: flex;justify-content: center;align-items: center;margin-bottom: 30px">
            <img style="width:200px;height:200px" alt="" th:src="@{img/logo.svg}"/>
        </div>
        <el-steps style="width: 100%" align-center :active="active" finish-status="success">
            <el-step title="填写登录 1"></el-step>
            <el-step title="选择时间及座位 2"></el-step>
            <el-step title="开始抢票 3"></el-step>
        </el-steps>
        <div style="margin-top:20px;display: flex;align-items: center;justify-content: center">
            <el-form v-show="active==0" size="mini" style="width: 500px" ref="loginForm" :rules="rulesUser"
                     :model="userForm">
                <el-form-item label="电话" prop="phone">
                    <el-input style="width: 100%" size="mini" v-model="userForm.phone" @input="verifyPhone"/>
                </el-form-item>
                <el-form-item v-if="showCodeInput" label="验证码" prop="phoneCode">
                    <el-input style="width: 100%" size="mini" v-model="userForm.phoneCode">
                        <el-button v-if="!showCountDown" style="padding-right:10px" slot="suffix" @click="getPhoneCheck"
                                   type="text">获取验证码
                        </el-button>
                        <div v-if="showCountDown" style="padding-right:10px" slot="suffix">{{countDown}}秒后重新获取</div>
                    </el-input>
                </el-form-item>
                <el-form-item style="height: 40px">
                    <div id="nc" style="width: 100%" v-if="checkIf"></div>
                </el-form-item>
                <el-form-item>
                    <el-button size="mini" v-if="showLogin&&checkIf" v-loading="loginLoading" @click="login">登录
                    </el-button>
                </el-form-item>
            </el-form>
            <el-form v-show="active==1" size="mini" style="width: 500px" ref="showForm" :model="showForm"
                     :rules="rulesShow">
                <el-form-item label="演出网页地址URL" prop="url">
                    <el-input size="mini" @change="loadShowInfo" style="width: 100%" v-model="showForm.url"
                              placeholder="例如 https://www.polyt.cn/show/465179627075854336/689/20057"/>
                </el-form-item>
                <el-form-item label="演出时间" prop="showTime" v-show="showList.length>0">
                    <el-select size="mini" style="width: 100%" v-model="showForm.showTime" @change="selectShow">
                        <el-option v-for="item in showList" :key="item.showId" :value="item.showId"
                                   :label="item.venueName +'->'+item.showTime"/>
                    </el-select>
                </el-form-item>
                <el-form-item label="座位等级" prop="level" v-show="seatGradeList.length>0">
                    <el-select size="mini" style="width: 100%" v-model="showForm.level">
                        <el-option v-for="item in seatGradeList" :key="item.priceId" :value="item.priceId">
                            <span :style="`background:${item.ticketPriceColor};color:#fff`">{{ `等级${item.priceGradeShow} ${item.price}元 剩余${item.reservedCount}张` }}</span>
                        </el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <el-form v-show="active==2" size="mini" style="width: 500px">
                <el-form-item label="取票人姓名">
                    <el-input size="mini" style="width: 100%" v-model="orderForm.getTickName"></el-input>
                </el-form-item>
                <el-form-item label="观影人">
                    <el-select size="mini" style="width: 100%" v-model="orderForm.showWatcher">
                        <el-option v-for="item in showUserList" :key="item.id" :value="item.name"/>
                    </el-select>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" size="mini" @click="startClaw">开始</el-button>
                    <el-button type="warning" size="mini">停止</el-button>
                </el-form-item>
            </el-form>
        </div>
        <div style="width:100%;display: flex;justify-content: center">
            <el-button @click="prev" size="mini" v-if="active>1">上一步</el-button>
            <el-button @click="next" size="mini" v-if="active<2">下一步</el-button>
        </div>
        <el-divider content-position="center">抢票日志</el-divider>
        <el-input type="textarea" v-model="log" :rows="10"/>
    </div>
</div>
<script th:src="@{js/element.js}"></script>
<script type="text/javascript">
    Vue.prototype.$dws = new websocket();
    const vm = new Vue({
        el: '#app',
        data: {
            token: "",
            userForm: {
                phone: "",
                phoneCode: "",
            },
            showForm: {
                url: "",
                level: null,
                showTime: null,
            },
            orderForm: {
                getTickName: null,
                showWatcher: null,
            },
            rulesUser: {
                phone: [{required: true, message: '请输入电话号码', trigger: 'blur'}],
                phoneCode: [{required: true, message: '请输入验证码', trigger: 'blur'}],
            },
            rulesShow: {
                url: [{required: true, message: '请输入演出网址', trigger: 'blur'}],
                level: [{required: true, message: '请选择座位等级', trigger: 'change'}],
                showTime: [{required: true, message: '请选择演出时间', trigger: 'change'}],
            },
            active: 0,
            countDown: 60,
            log: '',
            userModel: null,
            projectInfo: null,
            showList: [],
            showUserList: [],
            seatGradeList: [],
            ncModel: null,
            showCodeInput: false,
            checkIf: false,
            showCountDown: false,
            showLogin: true,
            loginLoading: false,
            service: axios.create({
                baseURL: "http://127.0.0.1:8020/", // url = base url + request url
                withCredentials: true, // send cookies when cross-domain requests
                timeout: 50000, // request timeout
            })
        },
        mounted() {
            this.$nextTick(() => {
                this.init();
                this.$dws.on("msg", (e) => {
                    this.log += `${new Date().toLocaleString()} ${e} \n`;
                }, "123");
                this.$dws.connect("ws://127.0.0.1:13245/websocket_stream");
            })
        },
        methods: {
            init() {
                this.getToken();
                this.loadCk(localStorage.getItem("cookies")).then(() => {
                }).finally(() => {
                    this.checkUser();
                })
                if (localStorage.getItem("project")) {
                    this.projectInfo = JSON.parse(localStorage.getItem("project"))
                    this.showForm.url = this.projectInfo.url;
                    this.showList = this.projectInfo.shows;
                }
            },
            next() {
                if (this.active === 0) {
                    this.checkUser()
                } else if (this.active === 1) {
                    this.$refs['showForm'].validate((valid) => {
                        if (valid) {
                            this.nextStep();
                        }
                    })
                } else {
                    this.nextStep();
                }
            },
            prev() {
                this.active--;
            },
            nextStep() {
                if (this.active++ > 2) this.active = 0;
            },
            loadCk(ck) {
                return this.service.post("user/loadCookie", null, {params: {ck}})
            },
            getToken() {
                this.service.get("user/getToken").then((resp) => {
                    if (resp.data.status === 200 && resp.data.code === 'OK') {
                        this.token = resp.data.message;
                        window.localStorage.setItem("token", this.token)
                    }
                })
            },
            checkUser() {
                this.service.get("user/checkUser").then((resp) => {
                    if (resp.data.status === 200 && resp.data.code === 'OK') {
                        if (resp.data.message.cookie.length > 1) {
                            this.showUserList = resp.data.message.watchers;
                            this.userModel = resp.data.message;
                            window.localStorage.setItem("cookies", this.userModel.cookie.join(";"))
                            this.showLogin = false;
                            this.nextStep();
                        }
                    }
                })
            },
            getPhoneCheck() {
                let dto = {
                    checkModel: JSON.stringify(this.ncModel), code: "", loginFlag: false, phoneArea: "86",
                    phone: this.userForm.phone, phoneCode: ""
                }
                this.service.post("user/sendPhone", dto).then((resp) => {
                    if (resp.data.status === 200 && resp.data.code === 'OK') {
                        this.showCountDown = true;
                        this.countDownCode();
                    }
                })
            },
            countDownCode() {
                this.intVal = setInterval(() => {
                    this.countDown--;
                    if (this.countDown === 0) {
                        clearInterval(this.intVal);
                        this.showCountDown = false;
                    }
                }, 1000)
            },
            login() {
                this.$refs['loginForm'].validate((valid) => {
                    if (valid) {
                        this.loginLoading = true
                        let dto = {
                            checkModel: JSON.stringify(this.ncModel), code: "", loginFlag: false, phoneArea: "86",
                            phone: this.userForm.phone, phoneCode: this.userForm.phoneCode
                        }
                        this.service.post("user/login", dto).then((resp) => {
                            this.showLogin = !(resp.data.status === 200 && resp.data.code === 'OK');
                            this.loginLoading = false;
                        }).catch(() => {
                            this.showLogin = true;
                            this.loginLoading = false;
                        })
                    }
                });
            },
            loadShowInfo() {
                if (this.showForm.url && this.showForm.url !== "") {
                    this.resetShowForm()
                    this.service.get("project/projectInfo", {params: {url: this.showForm.url}}).then((resp) => {
                        if (resp.data.status === 200 && resp.data.code === 'OK') {
                            this.projectInfo = resp.data.message;
                            localStorage.setItem("project", JSON.stringify(resp.data.message));
                            this.showList = this.projectInfo.shows;
                        }
                    })
                }
            },
            selectShow(e) {
                this.seatGradeList = [];
                for (let i = 0; i < this.showList.length; i++) {
                    if (this.showList[i].showId === e) {
                        this.seatGradeList = this.showList[i].ticketPriceList
                    }
                }
            },
            startClaw() {
                console.log(this.cookie, this.url)
            },
            resetShowForm() {
                this.showList = [];
                this.seatGradeList = [];
                this.showForm.level = null;
                this.showForm.showTime = null
            },
            verifyPhone(e) {
                let list = []
                let result = true
                let msg = ''
                var isPhone = /^1\d{10}$/
                if (e != null && e !== "") {
                    if (!isPhone.test(e)) {
                        msg = '手机号码格式不正确'
                    } else {
                        result = false
                    }
                } else {
                    msg = '手机号码不能为空'
                }
                list.push(result)
                list.push(msg)
                this.checkIf = !list[0];
                if (this.checkIf) {
                    this.$nextTick(() => {
                        this.initNc()
                    })
                } else {
                    window.ncModel = null
                }
            },
            initNc() {
                let thisCallback = this
                AWSC.use("nc", function (state, module) {
                    window.nc = module.init({
                        appkey: 'FFFF0N00000000009D3A', scene: 'nc_login_h5', renderTo: 'nc',
                        success: (data) => {
                            thisCallback.ncModel = data
                            thisCallback.showCodeInput = true;
                            console.log(data.sessionId)
                            console.log(data.sig)
                            console.log(data.token)
                        },
                        fail: (failCode) => {
                            console.log('fail', failCode)
                        },
                        error: (errorCode) => {
                            console.log('error', errorCode)
                        }
                    });
                })
            }
        }
    });
</script>
</body>
</html>