<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>保利抢票</title>
    <link rel="stylesheet" th:href="@{css/elementui.css}">
    <script th:src="@{js/axios.js}"></script>
    <script th:src="@{js/vue2.6.12.js}"></script>
    <script th:src="@{js/websocket.js}"></script>
    <script src="https://g.alicdn.com/AWSC/AWSC/awsc.js"></script>
    <style>
        html, body {
            padding: 0;
            margin: 0
        }
    </style>
</head>
<body>
<div id="app" style="height:100vh;width:100%;display: flex;justify-content: center;align-items: center">
    <div style="width: 700px;display: block">
        <div style="width:100%;display: flex;justify-content: center;align-items: center;margin-bottom: 30px">
            <svg style="width:200px;height:200px" t="1621352838873" class="icon" viewBox="0 0 1056 1024" version="1.1"
                 xmlns="http://www.w3.org/2000/svg"
                 p-id="1881" width="32" height="32">
                <path d="M333.994 531.026c-3.39-25.618 112.102-62.628 183.84-79.899 55.65-13.401 117.551-27.788 200.497-22.918 73.577 4.314 175.753 10.319 218.125 80.443 13.635 22.573 16.089 43.531 18.271 62.122 11.33 96.703-50.546 172.006-84.042 212.861-38.97 47.452-91.463 91.957-103.225 83.13-10.54-7.902 21.13-51.471 33.151-137.879 5.967-42.915 9.209-64.49-1.516-86.779-31.708-65.871-138.077-70.666-144.858-70.889-63.972-2.084-76.436 26.666-143.773 17.591-10.121-1.369-34.446-8.519-83.117-22.832-88.493-26.037-92.759-30.537-93.351-34.951z"
                      fill="#FA1919" p-id="1882"></path>
                <path d="M395.945 547.175c1.516-10.823 58.178 1.023 160.589-16.027 65.341-10.911 83.968-22.61 131.285-18.492 26.222 2.281 65.76 5.77 98.231 29.982 68.546 51.113 73.452 170.772 39.117 253.397-37.182 89.467-120.386 135.501-127.586 128.782-8.63-8.013 94.275-87.593 97.172-209.939 0.395-16.409 2.195-90.971-45.344-125.564-26.777-19.492-58.548-18.492-114.050-16.767-66.388 2.073-75.794 15.743-125.404 12.883-59.805-3.489-115.541-27.357-114.012-38.256z"
                      fill="#C40000" p-id="1883"></path>
                <path d="M486.471 446.342c5.178 8.63-1.072 23.091-9.049 31.252-22.129 22.659-72.577 12.118-76.090-2.182-2.626-10.676 20.292-26.063 38.217-32.054 13.155-4.389 39.673-9.098 46.921 2.983z"
                      fill="#FADC4A" p-id="1884"></path>
                <path d="M766.954 585.813c-2.615-5.017-6.758-8.932-11.805-11.193-37.609-25.879-86.711-28.086-100.877-28.086-25.273 0-42.717 5.559-58.116 10.455-16.595 5.898-35.759 9.66-55.691 10.433 19.38-1.753 10.66-1.069 1.78-1.069-1.977 0-3.946-0.035-5.908-0.101-37.452-1.434-112.816-33.575-147.31-45.249-24.397-8.211-60.052-17.001-106.998-17.333q2.466-1.516 5.153-3.107c26.567-15.769 59.46-31.61 92.623-44.603 9.291-3.675 15.742-12.578 15.742-22.988 0-13.618-11.039-24.657-24.657-24.657-3.271 0-6.394 0.638-9.251 1.793-40.876 15.968-81.831 36.383-112.195 55.789s-60.483 43.149-51.262 70.135c2.35 7.024 7.162 12.691 13.388 16.096-18.128 1.943-35.657 4.090-53.686 4.099q-2.988-0.001-6.414-0.187c-23.584-30.82-17.173-83.833 1.59-120.743 30.057-59.065 96.322-87.852 192.963-113.605 50.028 1.393 92.809 11.49 128.214 19.861 52.519 12.402 90.453 21.378 116.355-5.326 12.181-12.55 22.697-35.308 17.025-55.6-2.374-8.1-6.786-14.985-12.649-20.297 35.618-4.015 54.492-15.505 62.493-36.969 8.63-23.127 3.958-58.83-18.752-78.544-34.791-30.18-97.394-6.164-157.988 16.976-57.709 22.092-117.329 44.912-146.917 17.433-13.29-12.329-17.395-31.006-15.559-44.012 4.463-31.561 47.612-58.498 107.43-67.017 1.521-0.222 2.676-1.517 2.676-3.083 0-1.719-1.394-3.113-3.113-3.113-0.155 0-0.306 0.011-0.455 0.033-63.499 9.072-107.733 37.451-112.652 72.292-2.059 14.585 2.54 35.518 17.469 49.387 32.387 30.094 93.844 6.571 153.278-16.175 58.881-22.511 119.757-45.812 151.737-18.049 20.416 17.716 24.73 51.026 17.013 71.726-7.397 19.725-25.89 30.401-56.55 39.019-42.473-42.113-171.967-46.848-254.321-38.526s-161.501 35.444-235.471 80.566c-0.919 0.545-1.524 1.531-1.524 2.659 0 1.702 1.38 3.083 3.082 3.083 0.611 0 1.18-0.177 1.659-0.485 73.206-44.633 151.627-71.498 232.994-79.696 40.881-4.142 104.162-5.573 159.207 2.835 47.686 7.286 73.687 19.257 87.532 31.45-18.111 4.66-40.017 8.852-65.895 13.808-29.268 5.597-62.431 11.947-101.363 20.959-26.889 6.263-52.087 12.329-75.561 18.555-8.63-0.221-17.518-0.197-26.604 0.147-47.802 2.798-92.537 11.897-134.7 26.502-5.264 1.075-31.979 12.874-53.615 27.065-27.134 17.728-46.367 39.242-57.302 63.961-11.762 26.604-18.418 67.584 1.54 95.495 14.030 19.627 39.945 31.326 73.588 33.434 17.321 20.773 48.191 32.387 85.694 32.387q3.612 0 7.311-0.147c35.591-1.393 74.907-12.761 113.111-32.436 14.791 3.596 27.814 9.039 39.693 16.19-2.966-3.479 0.571 2.5 33.587 14.681 16.804 6.164 29.872 9.863 34.039 10.948 4.721 1.233 10.418 2.762 16.964 4.278-12.713 6.195-27.562 10.169-43.242 11.004 1.351 0.646-8.943-0.033-21.987-0.895-25.827-1.702-26.691-0.9-32.251-0.937-0.183-0.001-0.401-0.001-0.62-0.001-21.367 0-41.978 3.249-61.361 9.281-19.806 6.18-46.039 14.279-51.193 33.29-0.443 1.639-3.316 12.242 2.786 20.329s17.186 8.285 18.492 8.297c3.695-0.016 7.196-0.829 10.345-2.277 14.693-6.143 44.454-16.217 68.506-18.682 2.676-0.272 7.718-0.505 17.814-0.974 12.945-0.604 23.239-0.863 31.006-1.023 23.633-0.481 40.462-0.431 43.642-0.469 18.011-0.234 46.724-9.247 92.906-49.474 10.772-0.462 20.941-1.797 30.807-3.945 17.332-3.221 39.699-11.071 60.342-21.783-19.399 9.762-8.119 6.174 9.462 6.162 11.193 0.127 22.022 1.365 32.478 3.609-27.251 26.090-20.458 59.684-19.583 63.518 2.894 10.634 12.464 18.324 23.829 18.324 13.618 0 24.657-11.039 24.657-24.657 0-1.575-0.148-3.115-0.429-4.608-0.148-0.771-2.17-12.384 5.695-20.238 3.923-3.863 9.311-6.249 15.257-6.249 2.159 0 4.245 0.315 6.214 0.901 1.849 0.546 4.147 0.882 6.525 0.882 13.618 0 24.657-11.039 24.657-24.657 0-6.534-2.542-12.475-6.691-16.887zM422.241 302.964c38.81-9.037 71.923-15.374 101.093-20.959 27.578-5.277 50.745-9.714 69.778-14.794 5.097 5.605 8.585 12.758 9.683 20.676 3.817 12.402-5.726 32.768-16.711 44.098-23.423 24.188-59.965 15.559-110.511 3.612-30.957-7.311-67.509-15.94-109.722-19.023 17.913-4.549 36.701-9.024 56.39-13.611zM79.771 525.034c-11.527-16.125-18.69-49.226-0.924-89.43 10.442-23.621 28.91-44.222 54.886-61.248 21.13-13.845 47.291-25.396 77.743-34.31 38.959-11.609 83.777-18.517 130.135-19.001l-18.761 0.644c-86.606 24.829-146.523 54.245-175.297 110.807-10.764 20.958-17.257 45.663-17.705 71.841-0.812 16.306 3.835 36.033 13.661 51.147-29.145-2.786-51.532-13.364-63.738-30.451zM241.113 588.143c-36.073 1.418-66.228-7.914-84.128-25.766h2.65c21.171-0.183 41.574-3.129 60.973-8.496 0.999 2.304 5.902 3.185 11.004 3.227 5.74 0.239 13.655-0.623 23.678-1.709 28.947-3.131 63.158-0.949 89.689 4.339-35.321 17.198-71.233 27.11-103.867 28.391z"
                      fill="#000000" p-id="1885"></path>
                <path d="M685.303 962h-0.431c-12.157-0.209-26.654-11.095-28.478-24.657-1.233-9.443 3.328-17.58 9.159-24.509 3.76-4.476 8.827-9.407 15.237-15.645 24.73-24.090 70.764-68.915 86.298-136.647 0.419-1.812 1.097-4.795 1.85-8.692 4.611-23.721 6.473-29.378 4.093-36.653-1.085-3.328-2.873-8.186-6.521-9.049-7.065-1.665-18.923 12.329-22.709 27.566-3.378 13.562-2.158 16.804-1.060 30.339 0.051 0.596 0.081 1.29 0.081 1.99 0 13.618-11.039 24.657-24.657 24.657-12.917 0-23.514-9.933-24.571-22.577-2.471-31.084 6.922-61.164 14.603-73.838 7.902-13.043 16.446-27.122 34.334-34.026 16.532-6.386 31.894-3.107 38.674-1.233 15.988 6.16 28.879 17.392 36.99 31.691 14.863 17.597 1.782 88.916-41.195 169.679 8.802-6.928 21.082-17.075 34.963-30.169 30.303-28.589 77.213-72.836 104.902-141.27 14.72-36.393 36.011-88.628 17.26-147.225-13.66-42.594-41.843-68.397-51.113-76.868-56.981-52.051-129.743-53.357-230.466-55.181-4.633-0.102-10.089-0.16-15.561-0.16-59.258 0-116.929 6.797-172.275 19.653 3.423-0.585 1.476-0.346-0.528-0.346-13.621 0-24.663-11.042-24.663-24.663 0-11.721 8.175-21.531 19.133-24.041 53.696-12.676 115.159-19.925 178.315-19.925 5.786 0 11.557 0.061 17.314 0.182 52.51 0.948 98.605 1.774 141.472 10.071 49.313 9.542 87.605 27.985 120.436 58.029 11.65 10.665 47.119 43.149 64.773 98.195 41.917 130.569-60.409 254.444-94.015 295.14-17.333 16.89-32.263 30.969-43.617 41.547 0 0-106.381 98.627-158.025 98.627z"
                      fill="#000000" p-id="1886"></path>
            </svg>
        </div>
        <el-steps style="width: 100%" align-center :active="active" finish-status="success">
            <el-step title="填写登录 1"></el-step>
            <el-step title="选择时间及座位 2"></el-step>
            <el-step title="开始抢票 3"></el-step>
        </el-steps>
        <div style="margin-top:20px;display: flex;align-items: center;justify-content: center">
            <el-form v-if="active==0" size="mini" style="width: 500px">
                <el-form-item label="电话">
                    <el-input style="width: 100%" size="mini" v-model="userForm.phone"/>
                </el-form-item>
                <el-form-item label="Cookies">
                    <el-input type="textarea" style="width: 100%" size="mini" :row="5"
                              v-model="userForm.cookie"></el-input>
                </el-form-item>
                <el-form-item style="height: 40px" v-if="checkIf">
                    <div id="nc" style="width: 100%"></div>
                    <script>
                        // 实例化nc
                        AWSC.use("nc", function (state, module) {
                            // 初始化
                            window.nc = module.init({
                                // 应用类型标识。它和使用场景标识（scene字段）一起决定了滑动验证的业务场景与后端对应使用的策略模型。您可以在人机验证控制台的配置管理页签找到对应的appkey字段值，请务必正确填写。
                                appkey: 'FFFF0N00000000009D3A',
                                //使用场景标识。它和应用类型标识（appkey字段）一起决定了滑动验证的业务场景与后端对应使用的策略模型。您可以在人机验证控制台的配置管理页签找到对应的scene值，请务必正确填写。
                                scene: 'nc_login_h5',
                                // 声明滑动验证需要渲染的目标ID。
                                renderTo: 'nc',
                                //前端滑动验证通过时会触发该回调参数。您可以在该回调参数中将会话ID（sessionId）、签名串（sig）、请求唯一标识（token）字段记录下来，随业务请求一同发送至您的服务端调用验签。
                                success: (data) => {
                                    this.$emit('success', {
                                        token: data.token,
                                        sessionId: data.sessionId,
                                        sig: data.sig
                                    })
                                    console.log(data.sessionId)
                                    console.log(data.sig)
                                    console.log(data.token)
                                },
                                // 滑动验证失败时触发该回调参数。
                                fail: (failCode) => {
                                    console.log('fail', failCode)
                                },
                                // 验证码加载出现异常时触发该回调参数。
                                error: (errorCode) => {
                                    console.log('error', errorCode)
                                }
                            });
                        })
                    </script>
                </el-form-item>
            </el-form>
            <el-form v-if="active==1" size="mini" style="width: 500px">
                <el-form-item label="演出网页地址URL">
                    <el-input size="mini" @change="loadShowInfo" style="width: 100%" v-model="showForm.url"/>
                </el-form-item>
                <el-form-item label="演出时间">
                    <el-select size="mini" style="width: 100%" v-model="showForm.showTime">
                        <el-option v-for="item in showList" :key="item.val" :value="item.label"/>
                    </el-select>
                </el-form-item>
                <el-form-item label="座位等级">
                    <el-input-number style="width: 100%" size="mini" :min="1" :max="5" v-model="showForm.level"/>
                </el-form-item>
            </el-form>
            <el-form v-if="active==2" size="mini" style="width: 500px">
                <el-form-item label="取票人姓名">
                    <el-input size="mini" style="width: 100%" v-model="showForm.getTickName"></el-input>
                </el-form-item>
                <el-form-item label="观影人">
                    <el-select size="mini" style="width: 100%" v-model="showForm.showWatcher">
                        <el-option v-for="item in showUserList" :key="item.id" :value="item.label"/>
                    </el-select>
                </el-form-item>
                <el-form-item>
                    <el-button type="primary" size="mini" @click="startClaw">开始</el-button>
                </el-form-item>
            </el-form>
        </div>
        <div style="width:100%;display: flex;justify-content: center">
            <el-button @click="next" size="mini" v-if="active<2">下一步</el-button>
        </div>
        <el-divider content-position="center">抢票日志</el-divider>
        <el-input type="textarea" v-model="log" :rows="10"/>
    </div>
</div>
<script th:src="@{js/element.js}"></script>
<script type="text/javascript">
    Vue.prototype.$dws = new websocket();
    const vm = new Vue({
        el: '#app',
        data: {
            userForm: {
                phone: "",
                cookie: "",
            },
            showForm: {
                url: "",
                level: 1,
                showTime: '',
                getTickName: "",
                showWatcher: "",
            },
            active: 0,
            showList: [],
            log: '',
            checkIf: true,
            showUserList: [],
            service: axios.create({
                baseURL: "http://127.0.0.1:8020/", // url = base url + request url
                withCredentials: true, // send cookies when cross-domain requests
                timeout: 50000, // request timeout
            })
        },
        mounted() {
            this.$nextTick(() => {
                this.$dws.on("msg", (e) => {
                    this.log += `${new Date().toLocaleString()} ${e} \n`;
                }, "123");
                this.$dws.connect("ws://127.0.0.1:13245/websocket_stream");
            })
        },
        methods: {
            next() {
                if (this.active === 0) {
                    this.getUser(this.userForm).then((resp) => {
                        if (resp.data.status === 200 && resp.data.code === 'OK') {
                            this.nextStep();
                        }
                    })
                } else if (this.active === 1) {

                }
            },
            nextStep() {
                if (this.active++ > 2) this.active = 0;
            },
            getUser(dto) {
                return this.service.post("user/addUserSession", dto)
            },
            loadShowInfo() {

            },
            startClaw() {
                console.log(this.cookies, this.url)
            }
        }
    });
</script>
</body>
</html>